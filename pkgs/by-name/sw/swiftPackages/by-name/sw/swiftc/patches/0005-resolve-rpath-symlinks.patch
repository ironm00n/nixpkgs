From be0bfed556050c71030957fbe07ab57f4591f98f Mon Sep 17 00:00:00 2001
From: Randy Eckenrode <randy@largeandhighquality.com>
Date: Sun, 1 Feb 2026 16:14:09 -0500
Subject: [PATCH] resolve-rpath-symlinks

---
 lib/Driver/DarwinToolChains.cpp | 15 ++++++++++++---
 lib/Driver/UnixToolChains.cpp   |  7 ++++++-
 2 files changed, 18 insertions(+), 4 deletions(-)

diff --git a/lib/Driver/DarwinToolChains.cpp b/lib/Driver/DarwinToolChains.cpp
index 7d4d7d61071..013c0a53ad2 100644
--- a/lib/Driver/DarwinToolChains.cpp
+++ b/lib/Driver/DarwinToolChains.cpp
@@ -39,6 +39,8 @@
 #include "llvm/Support/Program.h"
 #include "llvm/Support/VersionTuple.h"
 
+#include <unistd.h>
+
 using namespace swift;
 using namespace swift::driver;
 using namespace llvm::opt;
@@ -149,9 +151,13 @@ static void addLinkRuntimeLibRPath(const ArgList &Args,
 
   SmallString<128> ClangLibraryPath;
   TC.getClangLibraryPath(Args, ClangLibraryPath);
-
+  
+  char pathBuf[4096];
+  if(readlink(ClangLibraryPath.c_str(), pathBuf, sizeof(pathBuf)) < 0) { abort(); }
+  std::string pathString(pathBuf);
+  
   Arguments.push_back("-rpath");
-  Arguments.push_back(Args.MakeArgString(ClangLibraryPath));
+  Arguments.push_back(Args.MakeArgString(pathString));
 }
 
 static void addLinkSanitizerLibArgsForDarwin(const ArgList &Args,
@@ -426,9 +432,12 @@ toolchains::Darwin::addArgsToLinkStdlib(ArgStringList &Arguments,
     // optional behaviour so that people downloading snapshot toolchains for
     // testing new stdlibs will be able to link to the stdlib bundled in
     // that toolchain.
+    char pathBuf[4096];
     for (auto path : RuntimeLibPaths) {
+      if (readlink(path.c_str(), pathBuf, sizeof(pathBuf)) < 0) { abort(); }
+      std::string pathString(pathBuf);
       Arguments.push_back("-rpath");
-      Arguments.push_back(context.Args.MakeArgString(path));
+      Arguments.push_back(context.Args.MakeArgString(pathBuf));
     }
   } else if (!tripleRequiresRPathForSwiftLibrariesInOS(getTriple()) ||
              context.Args.hasArg(options::OPT_no_stdlib_rpath)) {
diff --git a/lib/Driver/UnixToolChains.cpp b/lib/Driver/UnixToolChains.cpp
index 33e61b82145..05febb13cad 100644
--- a/lib/Driver/UnixToolChains.cpp
+++ b/lib/Driver/UnixToolChains.cpp
@@ -37,6 +37,8 @@
 #include "llvm/Support/Process.h"
 #include "llvm/Support/Program.h"
 
+#include <unistd.h>
+
 using namespace swift;
 using namespace swift::driver;
 using namespace llvm::opt;
@@ -221,11 +223,14 @@ toolchains::GenericUnix::constructInvocation(const DynamicLinkJobAction &job,
                          /*Shared=*/!(staticExecutable || staticStdlib));
 
   if (addRuntimeRPath(getTriple(), context.Args)) {
+    char pathBuf[4096];
     for (auto path : RuntimeLibPaths) {
+      if (readlink(path.c_str(), pathBuf, sizeof(pathBuf)) < 0) { abort(); }
+      std::string pathString(pathBuf);
       Arguments.push_back("-Xlinker");
       Arguments.push_back("-rpath");
       Arguments.push_back("-Xlinker");
-      Arguments.push_back(context.Args.MakeArgString(path));
+      Arguments.push_back(context.Args.MakeArgString(pathString));
     }
   }
 
-- 
2.51.2

