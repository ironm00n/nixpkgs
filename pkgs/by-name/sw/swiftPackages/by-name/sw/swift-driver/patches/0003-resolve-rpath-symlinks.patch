From dd71fc52239b02ce61d74366ce7057e22b463a37 Mon Sep 17 00:00:00 2001
From: Randy Eckenrode <randy@largeandhighquality.com>
Date: Sun, 1 Feb 2026 16:17:12 -0500
Subject: [PATCH] resolve-rpath-symlinks

---
 Sources/SwiftDriver/Driver/Driver.swift                      | 2 +-
 .../Jobs/GenericUnixToolchain+LinkerSupport.swift            | 5 ++++-
 Sources/SwiftDriver/Jobs/Toolchain+LinkerSupport.swift       | 5 ++++-
 Sources/SwiftDriver/Utilities/VirtualPath.swift              | 2 +-
 swift                                                        | 1 +
 5 files changed, 11 insertions(+), 4 deletions(-)
 create mode 120000 swift

diff --git a/Sources/SwiftDriver/Jobs/GenericUnixToolchain+LinkerSupport.swift b/Sources/SwiftDriver/Jobs/GenericUnixToolchain+LinkerSupport.swift
index fa2bd813..9410f2b3 100644
--- a/Sources/SwiftDriver/Jobs/GenericUnixToolchain+LinkerSupport.swift
+++ b/Sources/SwiftDriver/Jobs/GenericUnixToolchain+LinkerSupport.swift
@@ -13,6 +13,7 @@
 import SwiftOptions
 
 import func TSCBasic.lookupExecutablePath
+import func TSCBasic.resolveSymlinks
 import struct TSCBasic.AbsolutePath
 
 extension GenericUnixToolchain {
@@ -169,7 +170,9 @@ extension GenericUnixToolchain {
           commandLine.appendFlag(.Xlinker)
           commandLine.appendFlag("-rpath")
           commandLine.appendFlag(.Xlinker)
-          commandLine.appendPath(path)
+          try fileSystem.resolvingVirtualPath(path) { path in
+            try commandLine.appendPath(TSCBasic.resolveSymlinks(path))
+          }
         }
       }
 
diff --git a/Sources/SwiftDriver/Jobs/Toolchain+LinkerSupport.swift b/Sources/SwiftDriver/Jobs/Toolchain+LinkerSupport.swift
index ab4cfe0f..8280ba95 100644
--- a/Sources/SwiftDriver/Jobs/Toolchain+LinkerSupport.swift
+++ b/Sources/SwiftDriver/Jobs/Toolchain+LinkerSupport.swift
@@ -12,6 +12,7 @@
 
 import SwiftOptions
 
+import func TSCBasic.resolveSymlinks
 import protocol TSCBasic.FileSystem
 
 extension Toolchain {
@@ -178,7 +179,9 @@ extension DarwinToolchain {
     )
     for path in try rpaths.paths(runtimeLibraryPaths: runtimePaths) {
       commandLine.appendFlag("-rpath")
-      commandLine.appendPath(path)
+      try fileSystem.resolvingVirtualPath(path) { path in
+        try commandLine.appendPath(TSCBasic.resolveSymlinks(path))
+      }
     }
   }
 
diff --git a/Sources/SwiftDriver/Utilities/VirtualPath.swift b/Sources/SwiftDriver/Utilities/VirtualPath.swift
index 66514785..d0da8b82 100644
--- a/Sources/SwiftDriver/Utilities/VirtualPath.swift
+++ b/Sources/SwiftDriver/Utilities/VirtualPath.swift
@@ -693,7 +693,7 @@ enum FileSystemError: Swift.Error {
 }
 
 extension TSCBasic.FileSystem {
-  private func resolvingVirtualPath<T>(
+  internal func resolvingVirtualPath<T>(
     _ path: VirtualPath,
     apply f: (AbsolutePath) throws -> T
   ) throws -> T {
diff --git a/swift b/swift
new file mode 120000
index 00000000..05aa5194
--- /dev/null
+++ b/swift
@@ -0,0 +1 @@
+/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/swift-driver
\ No newline at end of file
-- 
2.51.2

